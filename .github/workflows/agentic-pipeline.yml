# Vibe Data Platform - Agentic Pipeline Workflow
#
# This workflow gives Claude full developer control over the pipeline.
# Claude acts as an autonomous developer who can:
#   - Run dbt commands
#   - Diagnose and fix errors
#   - Commit fixes to the repository
#   - Create GitHub Issues for unresolvable problems
#   - Retry until success or max attempts reached
#
# Required GitHub Secrets:
#   CLAUDE_CODE_OAUTH_TOKEN   - OAuth token for Claude Code Action
#   AZURE_STORAGE_ACCOUNT     - Azure Storage account name
#   AZURE_STORAGE_KEY         - Azure Storage account access key
#   LOGIC_APP_EMAIL_URL       - Logic App HTTP trigger URL (optional)
#   NOTIFICATION_WEBHOOK_URL  - Teams or Slack webhook URL (optional)

name: Agentic Data Pipeline

permissions:
  contents: write       # Commit fixes directly
  pull-requests: write  # Create PRs if preferred
  issues: write         # Create issues for unresolvable failures
  id-token: write       # Required for claude-code-action

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6:00 AM UTC

  workflow_dispatch:
    inputs:
      dbt_command:
        description: 'dbt command to run'
        required: false
        default: 'build'
        type: choice
        options:
          - build
          - run
          - test
          - seed
      dbt_select:
        description: 'Model selection (optional)'
        required: false
        default: ''
      full_refresh:
        description: 'Run with --full-refresh'
        required: false
        default: false
        type: boolean
      max_retries:
        description: 'Max retry attempts for self-healing'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'

env:
  AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
  AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

jobs:
  # =============================================================================
  # Main Job: Claude acts as autonomous developer
  # =============================================================================
  agentic-pipeline:
    name: Claude Developer Agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for proper git operations

      - name: Configure Git
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@${{ github.repository_owner }}.github.io"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            **/requirements*.txt
            dbt/packages.yml

      - name: Install dependencies
        run: |
          pip install dbt-duckdb pyyaml requests azure-storage-blob

      - name: Setup directories
        run: |
          mkdir -p data/processed data/raw logs

      - name: Download DuckDB from Azure
        run: |
          az storage blob download \
            --account-name $AZURE_STORAGE_ACCOUNT \
            --container-name duckdb \
            --name vibe.duckdb \
            --file data/processed/vibe.duckdb \
            --auth-mode key \
            --account-key $AZURE_STORAGE_KEY \
            2>/dev/null || echo "No existing database, starting fresh"

      - name: Download raw data from Azure
        run: |
          az storage blob download-batch \
            --account-name $AZURE_STORAGE_ACCOUNT \
            --source raw \
            --destination data/raw \
            --auth-mode key \
            --account-key $AZURE_STORAGE_KEY \
            2>/dev/null || echo "No raw data in Azure or download failed"

      # =========================================================================
      # Claude Developer Agent - Full autonomy to run, fix, commit, and report
      # =========================================================================
      - name: Claude Developer Agent
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            # You are a Developer on the Vibe Data Platform

            You have full autonomy to run the data pipeline, fix any issues, commit your changes, and report results. Act like an experienced data engineer.

            ## Your Mission

            Run the dbt pipeline and ensure it succeeds. If it fails, diagnose the problem, fix it, and retry. You have up to **${{ inputs.max_retries || '3' }} attempts**.

            ## Pipeline Command

            ```bash
            cd dbt && dbt ${{ inputs.dbt_command || 'build' }}${{ inputs.dbt_select && format(' --select {0}', inputs.dbt_select) || '' }}${{ inputs.full_refresh == 'true' && ' --full-refresh' || '' }}
            ```

            ## Your Capabilities

            You can do everything a developer would do:

            1. **Run commands** - Execute dbt, python scripts, any CLI tools
            2. **Read and edit files** - Examine models, fix SQL, update configs
            3. **Commit changes** - Use `git add`, `git commit`, `git push` to save fixes
            4. **Create GitHub Issues** - Use `gh issue create` for problems you can't solve
            5. **Use project skills** - `/diagnose`, `/apply-fix`, `/validate` are available

            ## Workflow

            1. **Run the pipeline** - Execute the dbt command
            2. **If success** - Report success and exit
            3. **If failure**:
               - Analyze the error output
               - Use `/diagnose` to understand root cause
               - Fix the issue (edit SQL, configs, etc.)
               - Create a backup before modifying files
               - Commit your fix with a descriptive message
               - Retry the pipeline
               - Repeat until success or max attempts exhausted

            ## Git Commit Guidelines

            When committing fixes:
            ```bash
            git add -A
            git commit -m "fix(dbt): <brief description>

            - Root cause: <what was wrong>
            - Fix applied: <what you changed>

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push origin ${{ github.ref_name }}
            ```

            ## If You Cannot Fix It

            After exhausting all attempts, create a detailed GitHub Issue:

            ```bash
            gh issue create \
              --title "Pipeline Failure: <brief description>" \
              --label "bug,pipeline,needs-triage" \
              --body "## Pipeline Failure Report

            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Branch:** ${{ github.ref_name }}
            **Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

            ## Error Summary
            <describe the error>

            ## Root Cause Analysis
            <your diagnosis>

            ## Attempted Fixes
            <what you tried>

            ## Recommended Manual Steps
            <what a human should do>

            ## Relevant Files
            - <list files involved>
            "
            ```

            ## Important Rules

            - **Be efficient** - Don't over-analyze, fix and move on
            - **Commit each fix** - Don't batch multiple unrelated fixes
            - **Preserve data** - Never delete production data
            - **Log everything** - Your output is the audit trail
            - **Confidence threshold** - Apply fixes you're >= 70% confident about
            - **Ask for help** - Create an issue rather than making risky changes

            ## Context

            - Repository: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Trigger: ${{ github.event_name }}
            - Run ID: ${{ github.run_id }}

            Now, run the pipeline and handle whatever comes up. Good luck!

          allowed_tools: |
            Bash
            Edit
            Read
            Write
            Glob
            Grep
            WebFetch
            WebSearch
            TodoWrite
            mcp__plugin_fabric-cli-plugin_microsoft-learn__microsoft_docs_search
            mcp__plugin_fabric-cli-plugin_microsoft-learn__microsoft_docs_fetch

          claude_args: |
            --max-turns 75

      # =========================================================================
      # Post-Agent: Upload results regardless of outcome
      # =========================================================================
      - name: Upload DuckDB to Azure
        if: always()
        run: |
          if [ -f "data/processed/vibe.duckdb" ]; then
            az storage blob upload \
              --account-name $AZURE_STORAGE_ACCOUNT \
              --container-name duckdb \
              --name vibe.duckdb \
              --file data/processed/vibe.duckdb \
              --overwrite \
              --auth-mode key \
              --account-key $AZURE_STORAGE_KEY
            echo "DuckDB uploaded to Azure"
          fi

      - name: Upload logs to Azure
        if: always()
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          for logfile in logs/*.log; do
            if [ -f "$logfile" ]; then
              BASENAME=$(basename "$logfile" .log)
              az storage blob upload \
                --account-name $AZURE_STORAGE_ACCOUNT \
                --container-name logs \
                --name "${BASENAME}_${TIMESTAMP}.log" \
                --file "$logfile" \
                --auth-mode key \
                --account-key $AZURE_STORAGE_KEY 2>/dev/null || true
            fi
          done

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-results
          path: |
            logs/
            data/processed/*.duckdb
          retention-days: 30

      # =========================================================================
      # Notifications
      # =========================================================================
      - name: Notify Success
        if: success()
        run: |
          if [ -n "${{ secrets.NOTIFICATION_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.NOTIFICATION_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "✅ Vibe Pipeline Succeeded",
                "attachments": [{
                  "color": "#00FF00",
                  "title": "Pipeline Success",
                  "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "text": "The agentic pipeline completed successfully."
                }]
              }' 2>/dev/null
          fi

      - name: Notify Failure
        if: failure()
        run: |
          if [ -n "${{ secrets.NOTIFICATION_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.NOTIFICATION_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "❌ Vibe Pipeline Failed",
                "attachments": [{
                  "color": "#FF0000",
                  "title": "Pipeline Failure - Check GitHub Issues",
                  "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "text": "The agentic pipeline failed after self-healing attempts. A GitHub Issue should have been created with details."
                }]
              }' 2>/dev/null
          fi

          if [ -n "${{ secrets.LOGIC_APP_EMAIL_URL }}" ]; then
            curl -X POST "${{ secrets.LOGIC_APP_EMAIL_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "subject": "Vibe Pipeline Failed - Manual Intervention Required",
                "body": "The pipeline failed after self-healing attempts.\n\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nCheck GitHub Issues for detailed root cause analysis.",
                "severity": "high"
              }' 2>/dev/null
          fi
